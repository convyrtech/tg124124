# Production Fix Plan
**Date**: 2026-02-13
**Based on**: `docs/plans/2026-02-13-full-audit-results.md`
**Goal**: Fix all P1 and P2 issues before 1000-account production run

## Status: COMPLETE
All P1 and P2 fixes implemented, tested (326/326 pass), verified with live accounts.

## Fix Groups (by dependency order)

### Group A: Fragment Auth Critical (P1 + P2) — DONE
**Agent**: fragment-fixer | **Commit**: a97fb8e

| # | Audit ID | Fix | File | Status |
|---|----------|-----|------|--------|
| A1 | #015 | Add dispatchEvent after phone input value set | src/fragment_auth.py:387 | [x] |
| A2 | #019 | Register Telethon event handler BEFORE phone submit | src/fragment_auth.py:441,650 | [x] |
| A3 | #021 | Check stel_ssid cookie INSIDE the loop, not after timeout | src/fragment_auth.py:517 | [x] |
| A4 | #018 | Add CAPTCHA detection after phone submit | src/fragment_auth.py:528 | [x] |
| A5 | #020 | Log page.reload() exception instead of silent pass | src/fragment_auth.py:668 | [x] |

### Group B: Fragment CLI (P2) — DONE
**Agent**: cli-fixer | **Commits**: a6c499f, 3a8835a

| # | Audit ID | Fix | File | Status |
|---|----------|-----|------|--------|
| B1 | #016 | fragment --all: skip already-authorized (query DB) | src/cli.py:898 | [x] |
| B2 | #017 | Add fragment --retry-failed flag | src/cli.py:848 | [x] |

### Group C: GUI CancelledError + Scale (P2) — DONE
**Agent**: gui-fixer | **Commit**: a467171

| # | Audit ID | Fix | File | Status |
|---|----------|-----|------|--------|
| C1 | #038 | _batch_migrate: except BaseException | src/gui/app.py:1448 | [x] |
| C2 | #039 | _batch_fragment: except BaseException | src/gui/app.py:1508 | [x] |
| C3 | #035 | Populate _status_cells before batch start | src/gui/app.py:1414 | [x] |
| C4 | #036 | Increase log deque to 5000 | src/gui/app.py:89 | [x] |
| C5 | #037 | STOP button: disable + "Stopping..." | src/gui/app.py:1407 | [x] |
| C6 | #040 | Font download: 5s timeout | src/gui/app.py:228 | [x] |

### Group D: Worker Pool & Batch (P2) — DONE
**Agent**: worker-fixer | **Commits**: a0eec75, 08f5236, c1677ad, 83ab97e, f0aaf8e

| # | Audit ID | Fix | File | Status |
|---|----------|-----|------|--------|
| D1 | #001 | Dynamic BATCH_TIMEOUT based on account count | src/telegram_auth.py:2307 | [x] |
| D2 | #002 | Share BrowserManager in migrate_accounts_parallel | src/telegram_auth.py:2348 | [x] |
| D3 | #004 | Save storage_state after token accepted even on failure | src/telegram_auth.py:1734 | [x] |
| D4 | #009 | Share BrowserManager in migrate_accounts_batch | src/telegram_auth.py:1906 | [x] |
| D5 | #030 | Worker: surface "run proxy-refresh" message on dead proxy | src/worker_pool.py:424 | [x] |
| D6 | #026 | Auto-close orphaned batches on new batch creation | src/database.py:783 | [x] |
| D7 | #023 | get_migration_stats: use SQL GROUP BY | src/database.py:716 | [x] |

### Group E: EXE & Deployment (P2) — DONE
**Agent**: exe-fixer | **Commits**: a07c0fb, 7be744a

| # | Audit ID | Fix | File | Status |
|---|----------|-----|------|--------|
| E1 | #041 | Create logs/ in main.py, add tkinter error on crash | main.py | [x] |
| E2 | #042 | Validate APP_ROOT for non-ASCII, warn user | src/paths.py:12 | [x] |
| E3 | #047 | Frozen mode: check bundled Camoufox path | src/gui/app.py:1686 | [x] |
| E4 | #049 | Wrap in-process pproxy in isolated task | src/proxy_relay.py:157 | [x] |
| E5 | #029 | find_free_port: retry loop (3 attempts) | src/proxy_relay.py:61 | [x] |

### Additional fixes found during audit (not in original plan)
| Fix | File | Commit |
|-----|------|--------|
| Non-retryable error classification (PhoneBanned, DeadSession, etc.) | src/worker_pool.py | 08f5236 |
| Migration_id leak on unhandled exception | src/worker_pool.py | 08f5236 |
| Skip dead proxies in _build_proxy_string() | src/worker_pool.py | c1677ad |
| Deep SOCKS5+Telegram health check (not just TCP) | src/proxy_manager.py | c1677ad |
| Atomic zip write in hibernate() (.tmp → rename) | src/browser_manager.py | 83ab97e |
| wait_closed() after pproxy server stop | src/proxy_relay.py | 83ab97e |
| Atomic complete_migration() — single transaction | src/database.py | f0aaf8e |
| assign_proxy() TOCTOU race — atomic UPDATE WHERE | src/database.py | f0aaf8e |
| stderr=None guard in frozen windowed mode | src/logger.py, src/exception_handler.py | 7be744a |
| PermissionError handling (write-protected dirs) | src/gui/app.py | 7be744a |
| CLI Database path + connect() fix | src/cli.py | 3a8835a |

### Group P3: Deferred (not blocking production)
- #005, #006, #007, #010, #013, #024, #025, #033, #034, #043, #044, #045, #046, #048

## Success Criteria
- [x] All 326+ tests pass (326/326, 0 failures)
- [x] fragment --all skips authorized accounts (verified: 7/7 OK, 7 correctly failed)
- [x] fragment --retry-failed works (hint shown at end of batch)
- [x] EXE builds without errors
- [x] No CancelledError leaks in GUI

## Live Verification (2026-02-13)
```
fragment --all (14 accounts, headless):
  OK (7): 573189007842, 573188398864, 573189007846, 573189007843,
          Софт 317, 573189007845, 573189007841
  FAIL (7): All expected — dead sessions (3), AuthKeyDuplicated (2),
            confirmation timeout (1), OAuth popup timeout (1)
  No crashes, no RuntimeWarnings, clean shutdown.
```
