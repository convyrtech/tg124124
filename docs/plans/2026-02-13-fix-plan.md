# Production Fix Plan
**Date**: 2026-02-13
**Based on**: `docs/plans/2026-02-13-full-audit-results.md`
**Goal**: Fix all P1 and P2 issues before 1000-account production run

## Fix Groups (by dependency order)

### Group A: Fragment Auth Critical (P1 + P2) — MUST FIX FIRST
**Agent**: fragment-fixer

| # | Audit ID | Fix | File | Status |
|---|----------|-----|------|--------|
| A1 | #015 | Add dispatchEvent after phone input value set | src/fragment_auth.py:387 | [ ] |
| A2 | #019 | Register Telethon event handler BEFORE phone submit | src/fragment_auth.py:441,650 | [ ] |
| A3 | #021 | Check stel_ssid cookie INSIDE the loop, not after timeout | src/fragment_auth.py:517 | [ ] |
| A4 | #018 | Add CAPTCHA detection after phone submit | src/fragment_auth.py:528 | [ ] |
| A5 | #020 | Log page.reload() exception instead of silent pass | src/fragment_auth.py:668 | [ ] |

### Group B: Fragment CLI (P2) — User requested
**Agent**: cli-fixer

| # | Audit ID | Fix | File | Status |
|---|----------|-----|------|--------|
| B1 | #016 | fragment --all: skip already-authorized (query DB) | src/cli.py:898 | [ ] |
| B2 | #017 | Add fragment --retry-failed flag | src/cli.py:848 | [ ] |

### Group C: GUI CancelledError + Scale (P2)
**Agent**: gui-fixer

| # | Audit ID | Fix | File | Status |
|---|----------|-----|------|--------|
| C1 | #038 | _batch_migrate: except BaseException | src/gui/app.py:1448 | [ ] |
| C2 | #039 | _batch_fragment: except BaseException | src/gui/app.py:1508 | [ ] |
| C3 | #035 | Populate _status_cells before batch start | src/gui/app.py:1414 | [ ] |
| C4 | #036 | Increase log deque to 5000 | src/gui/app.py:89 | [ ] |
| C5 | #037 | STOP button: disable + "Stopping..." | src/gui/app.py:1407 | [ ] |
| C6 | #040 | Font download: 5s timeout | src/gui/app.py:228 | [ ] |

### Group D: Worker Pool & Batch (P2)
**Agent**: worker-fixer

| # | Audit ID | Fix | File | Status |
|---|----------|-----|------|--------|
| D1 | #001 | Dynamic BATCH_TIMEOUT based on account count | src/telegram_auth.py:2307 | [ ] |
| D2 | #002 | Share BrowserManager in migrate_accounts_parallel | src/telegram_auth.py:2348 | [ ] |
| D3 | #004 | Save storage_state after token accepted even on failure | src/telegram_auth.py:1734 | [ ] |
| D4 | #009 | Share BrowserManager in migrate_accounts_batch | src/telegram_auth.py:1906 | [ ] |
| D5 | #030 | Worker: surface "run proxy-refresh" message on dead proxy | src/worker_pool.py:424 | [ ] |
| D6 | #026 | Auto-close orphaned batches on new batch creation | src/database.py:783 | [ ] |
| D7 | #023 | get_migration_stats: use SQL GROUP BY | src/database.py:716 | [ ] |

### Group E: EXE & Deployment (P2)
**Agent**: exe-fixer

| # | Audit ID | Fix | File | Status |
|---|----------|-----|------|--------|
| E1 | #041 | Create logs/ in main.py, add tkinter error on crash | main.py | [ ] |
| E2 | #042 | Validate APP_ROOT for non-ASCII, warn user | src/paths.py:12 | [ ] |
| E3 | #047 | Frozen mode: check bundled Camoufox path | src/gui/app.py:1686 | [ ] |
| E4 | #049 | Wrap in-process pproxy in isolated task | src/proxy_relay.py:157 | [ ] |
| E5 | #029 | find_free_port: retry loop (3 attempts) | src/proxy_relay.py:61 | [ ] |

### Group P3: Deferred (not blocking production)
- #005, #006, #007, #010, #013, #024, #025, #033, #034, #036, #043, #044, #045, #046, #048

## Execution Order

1. **Groups A + B** first (fragment auth — user needs to test with real accounts)
2. **Group C** (GUI — visible bugs)
3. **Group D** (worker pool — batch reliability)
4. **Group E** (EXE — deployment)
5. Run `pytest` after each group
6. Final `python build_exe.py` after all groups complete
7. Run `fragment --all` verification with real accounts

## Success Criteria
- [ ] All 326+ tests pass
- [ ] fragment --all skips authorized accounts
- [ ] fragment --retry-failed works
- [ ] EXE builds without errors
- [ ] No CancelledError leaks in GUI
